Python FAQ: Web开发
======================

原文： `Python FAQ: Webdev <http://me.veekun.com/blog/2012/05/05/python-faq-webdev/>`_

译者： `youngsterxyf <http://xiayf.blogspot.com/>`_

`Python FAQ <http://me.veekun.com/blog/2011/07/22/python-faq/>`_ 的一部分

**我只会PHP，那该怎么用Python来编写一个Web应用呢？**

这是一个相当复杂的问题，甚至很容易就能写一本书来探讨Web开发与Python，
以及如何关联两者，所以我很想先把这个问题放一放。但是鉴于我刚 `相当粗暴地捣毁了PHP <http://me.veekun.com/blog/2012/04/09/php-a-fractal-of-bad-design/>`_ ，明智些，还是回答这个问题吧，宜早不宜迟。

最直接简单的答案是：不要再读了，马上使用 `Flask <http://flask.pocoo.org/>`_ 着手构建一样东西。然而，我觉得还有更好回答。

本文并非是教程。也许将来我会写一篇，但现在已经存在大量的教程了，我认为你可以阅读那些文档。相反，本文是为新手而写的Python Web开发相关事情的概览。

------

起步
------

显然，你需要安装Python。确保使用Python 2，而不是3。Python 3有一些向后不兼容的改变，并非所有的库都更新过。

安装Python库，可以考虑使用 ``pip`` 。(如果你在使用类Unix操作系统，那么可能可以通过系统包管理器安装pip，否则使用 ``easy_install pip`` ) ``pip`` 是一个小巧的Python包管理器，便于安装，删除，升级，以及检查Python库。当然，尽可能使用你的系统包管理器，不行的话就用 ``pip`` 。

可以使用 ``pip install --user ...`` 将Python库安装到你的home目录，但更好的方式是保持库为每个项目局部可用---这样，你就可以为一个项目升级依赖项而不会破坏其他项目的依赖。(或者破坏Python编写的系统软件。我就曾干过这种事。) ``virtualenv`` 使用单个命令就能助你创建一个独立的Python安装环境。

当然，你已计划使用源码控制，对吧？我喜欢 `git <http://www.git-scm.com/>`_ ,  但有聊胜于无，其他的也OK的。

------

框架
------

第一个障碍是如何将你代码与浏览器相关连。PHP中，最简单的方式是安装Apache并将它指向一些文件。Python中，如同更大的PHP项目，一般需要使用Web框架。

框架多半有相似的工作流程：

- 安装，使用 ``pip`` 这样的工具。

- 创建一个项目骨干(skeleton)。

项目骨干的复杂性视情况而定。对于现已不被使用的Pylons，你会得到一大堆诡异的代码，还需要为新的发布版本手动升级。Flask则简单到没有骨干。复杂性适中的是Pyramid，项目骨干仅包括一些通用的样板文件(boilerplate)，这样你就不需要从零开始自己编写了。

- 配置一些东西，比如数据库。

- 启动开发服务器。

一般是一个运行你的应用的终端程序，从而不需要一个专用的HTTP服务器。当你修改了代码，开发服务器就会自动重新装载，并且能输出栈跟踪和其他调试信息。

- 动手干吧！

那么，应该用什么框架呢？虽然有不计其数的可选项，但有一些明显最流行。

我是 `Pyramid <http://www.pylonsproject.org/>`_ 的粉丝，它在极简主义与电池内置的庞然大物之间做出最佳的平衡。虽然它是从两个更老的组织良好的项目衍生而来，但在最近才成为一个竞争者。Pyramid设计良好，文档齐全，相当透明(fairly transparent)。一个简单的应用根本不需要自动生成的样板文件，允许你直接运行项目骨干，并且核心代码库扩展性非常好。有用的插件越来越多。

如果需要更快地上手， `Flask <http://flask.pocoo.org/>`_ 则足够简单了，但是可扩展性非常良好。其设计上与众不同地做了一些相当的合理的事情，且对你没有很多强迫。

`Bottle <http://bottlepy.org/docs/dev/>`_ 类似于Flask，但是更简单：它作为单个文件发布，没有任何依赖。是好是坏全看你自己，但这意味着Bottle中没有什么东西可以和其他框架分享的。我承认对Bottle知道的不是很多，但我曾简单地了解过(gave it a brief shot once)，对它没什么大的牢骚。

另一极端上， `Django <https://www.djangoproject.com/>`_ 是为类内容管理系统和其他富内容网站而设计的巨大怪兽。它有庞大的可插部件生态系统，内置从模板到ORM的各种东西，以及大量文档和社区资源。Django常被认为是与Ruby on Rails等价的Python框架。其缺点是让它做些它不想做的事情会很别扭。("#python"中许多更加愚钝的问题都是由于试图捣鼓Django而产生的)对于首次尝试Web开发来说，Django可能有些重量了。

还有 `web2py <http://www.web2py.com/>`_  。我，额，不太了解它。据说它会在你的模块名字空间内注入变量，这是令人讨厌的，所以如果你在意那些我认为讨厌的东西就不要用它，否则就用吧，随你自己啦。

曾经有一个Apache模块 ``mod_python`` ，本质上类似于 ``mod_perl`` ，但很早就被抛弃了。请 **不要** 使用它。

最后，你也可以完全"手动"编写Python web代码，但那多半是一次令人沮丧的练习。不会更快，不会有什么教育意义，也不会有什么用。不要自找麻烦。

我的建议？如果你只是想折腾捣鼓，那就从Flask入手吧，随你添加东西。如果你有想法要做一个网站，并且想旗开得胜(hit the ground running)，那就使用一个Pyramid脚手架(scaffold)，跟随它的叙述性文档进行开发。

------

路由选择(Routing)
---------------

PHP是根据URL执行一整个文件，Python web应用则倾向"拥有"一整个目录结构(或者甚至是整个域(domain))。因此，将特定的代码连接到特定的代码就更加灵活，这种连接通常是由一个路由选择系统来处理。

路由(routes)是包含可选占位符的URL，就像这样：

::

    /users/{name}
    /companies/{id}/products
    /blog/{year:\d\d\d\d}/{month:\d\d}/{day:\d\d}/{title}

你可以把这样的一个路由绑定到一个函数，那么当你浏览到 ``/users/eevee`` ，那个函数就会被执行，占位符则以 ``dict(name=u'eevee')`` 这样的结构可供使用。

一些框架(比如Pyramid)在这一步上走得更远：不是直接将路由绑定到函数，而是给路由一个名字，然后把名字绑定到函数。需要一点额外的工作，但优点是在你的应用中只需维护一个所有页面的核心列表。你也可以一个路由名和占位符值来生成一个URL---那么，之后，你就可以只在一个地方修改一下就能改变一个URL，而不需要接触其他东西，并且开发过程中打字错误会产生一个错误信息而不是一个404页面。

语法和具体实现会有些不同，但每个框架都是使用这个系统的某个变种。有些有助于创建REST风格的路由或者其他常见模式，或者你可以很容易编写自己的模式。

请求周期
---------

一次HTTP请求往往会执行某处的一个函数(由一个路由选择)，然后给函数传递一个 ``request`` 对象参数。

request对象的确切接口依赖于特定的框架，但是它们一般都比较类似：解析过的查询数据，一些cookie，请求消息头，等等。举例来说， `` `webob <http://www.webob.org>`_ `` 的 ``Request`` 对象包含：

- ``request.GET`` 和 ``request.POST`` 是存储解析过的查询数据的"multidict"。(对于 ``request.GET['foo']`` ，一个multidict返回的是单个值，但使用 ``getall()`` 方法则会返回所有的值)

- ``request.params`` 是包含上面两者的一个multidict。

- ``request.cookies`` 是一个cookie的解析字典。

- ``request.headers`` 是一个HTTP请求消息头的字典，但是其键是大小写敏感的。

- ``request.is_xhr`` 返回是否存在 ``X-Requested-with: XMLHttpRequest`` 消息头，以识别由jQuery这样的库设置的ajax请求。

request对象的文档一般非常齐全，因此只要浏览一下你所选择的框架的文档，挑出其中重要的内容。

当你的应用完成了一些非常酷的事情之后，你要让它返回一个响应消息。通常你能选择是否明确地构建一个 ``Response`` 对象(包括HTTP消息头和其他可手动设置的细节)还是简单返回一块HTML代码，其他所有东西都使用默认设置。很少需要你自己创建一个响应。对于像返回JSON这样的常见工作，每个框架都有某种快捷的或辅助的装饰器。

------

模板
------

组装HTML的工作一般是由模板引擎来完成的。 `Mako <http://www.makotemplates.org/>`_ 和 `Jiaja2 <>http://jinja.pocoo.org/`_ 是两个主要的竞争者。

我真的喜欢Mako。真的，真的，真的。使用它吧。它使用朴素的Python作为语法，使用起来非常自然。你甚至可以在模板里编写纯粹的Python代码块，但是你得控制住，尽可能避免这样做。:)

Jinja2也不错，但提醒你一下：Jinja2中，如果 ``foo`` 看起来像一个字典，那么 ``foo.bar`` 就会被当作 ``foo['bar']`` 处理，反之亦然。恰巧我认为这并不是一个好主意，我曾遭遇过许多诡异的问题，都是模板系统中这种"特性"所造成的。(另外， ``{% %}`` 这种语法真的很烦人，但这有些鸡蛋里挑骨头了)。除此之外，Jinja2是一个非常可靠的库，而你肯定会做得更糟， `糟得多 <http://www.cheetahtemplate.org/>`_ 。

这两个工具速度都很快，会自动编译成Python模块，具备优秀的可调试能力(以疯狂的做法从原来的模板源码中得到栈跟踪信息)，应该足够强大，让你想干啥就能干啥了。大致了解一下这两个，然后选一个就开始使用吧。如果你不知道或者无所谓用哪个，那就用Mako吧。

(注意，虽然Flask默认使用Jinja2，但使用Mako作为替代也是 `相当容易 <https://github.com/tzellman/flask-mako>`_ 的。)

当然还有其他的竞争者：排名第三的可能是Genshi，但它令人极其费解，以至于 `主页 <http://genshi.edgewall.org/>`_ 上一开始就用了一张流程图； Djano有自己的模板引擎，千方百计想把逻辑剔除出模板(在我看来，对其是不利的)；Bottle同样有自己的极其简单的模板，但是可能很快就会让你感到越来越痛苦；Pyramid的另一个内建模板引擎是Chameleon，将类似HTML的属性标签用于循环和其他逻辑，太TMD古怪了。

也许你会喜欢其中之一；我并没有都深入使用过它们。

不管你做什么，都不要使用Cheetah。 **不要** 使用Cheetah。它邪恶可憎。不要再提到它。

模板中的逻辑
--------------

也许你以前没用过模板，那你不可避免地会遭遇这个问题---一些复杂的表现代码是应该用Python实现，还是放在模板中实现。

这是无聊的老生常谈，但我想说：就像许多程序设计中的架构决策，归结起来就是要尽可能减少以后因为它而对自己的厌恶感。尽可能保持模板简单，如果不行的话，也不用勉强。谨记你始终可以在简单的Python模块中编写简单的Python函数，然后导入它。一个强大的模板语言对于你的问题可能内建了创造性的解决方案，所以当你在想办法的时候可以先浏览一下文档。

Unicode
--------

Unicode很烂。这是众所周知的事实。(我在说谎。编码(encoding)处理得很烂。Unicode很伟大。这个问题比较复杂，之后我会写到。)

Python(2)有两种"字符串"类型： ``str`` 和 ``unicode`` 。这是一个巧妙的谎言。事实是：一个 ``str`` 并不真的是一个字符串。它只是一串字节。有时恰巧看起来像一个字符串，但事实上只是一个二进制表示，就像 ``85 00 00 00`` 是数字133的常见二进制表示。一个真正的数字是 ``int`` 类型的，一个真正的字符串是 ``unicode`` 类型的。

这个问题很复杂，值得单独写一篇文章来解释(迟早我会写的)，但现在可以有些快速的笔记：

- 你的程序只需要担心真正的字符串(也就是 ``unicode`` 类型的)。字符串进入你的程序时需要解码，离开时需要编码，但是幸运的是，大多数的web框架都会为你做这事。

- 你可以使用 ``u`` 前缀来创建一个 ``unicode`` 的字面字符串，e.g.， ``u'foo'``

- 你可以在文件的顶部添加 ``from __future__ import unicode_literals`` 使得文件中的所有字面字符串默认为 ``unicode`` 。如果你确实需要一个 ``str`` 类型字符串，那就使用 ``b`` 前缀吧。

- 如果你想在Python源码中使用非ASCII字符，在顶部添加 ``#encoding: utf8`` 魔术注释。（当然是假定你的源码是保存为UTF-8编码的，这样做绝对更好。）

- **永远** 不要通过剥离非ASCII字符来解决Unicode问题！这是对很多人的无礼；想象一下当你尝试去使用一个网站，因为某个程序员懒得弄清楚如何处理英文字母，所以不允许你使用英文字母，你会是什么感受？

- 实际上，对于撼动编码问题，重音字母和亚洲字符功不可没。将一些非ASCII字符的莫名其妙的话粘贴到你的网站表单中，看看会发生什么。

XSS(跨站脚本攻击)
-------------------


